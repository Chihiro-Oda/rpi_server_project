{% extends 'field_app/base.html' %}

{% block title %}現場チャット{% endblock %}
{% block header_title %}現場チャット・レポート{% endblock %}

{% block content %}
    <div class="flex-1 flex flex-col p-4 space-y-4">
        <!-- 宛先選択 -->
        <div class="bg-gray-700 p-4 rounded-lg">
            <label for="group-select" class="block text-lg font-semibold mb-2 text-white">宛先グループ:</label>
            <select name="group_id" id="group-select" class="p-2 w-full border rounded-md bg-gray-600 text-white focus:ring-2 focus:ring-blue-500">
                <option value="all" {% if selected_group_id == 'all' %}selected{% endif %}>本部 (全体連絡)</option>
                {% for group in groups %}
                    <option value="{{ group.id }}"
                            {% if group.id|stringformat:"s" == selected_group_id %}selected{% endif %}>{{ group.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- チャットメッセージリスト (親コンテナ) -->
        <div id="chat-log"
             class="flex-1 bg-gray-800 p-4 rounded-lg shadow-inner overflow-y-auto border border-gray-700 space-y-4">

            {# 過去ログの表示 #}
            {% for msg in messages_history %}
                <div id="msg-{{ msg.id }}"
                     class="message-container text-base relative group mb-4 {% if msg.sender == request.user.username or msg.sender == request.user.full_name %}text-right{% endif %}"
                     data-msg-id="{{ msg.id }}">

                    {# 送信者名 #}
                    <p class="font-bold text-sm text-gray-400 mb-1">
                        {# sender_full_nameがあればそれを、なければsender(ID)を表示 #}
                        {{ msg.sender_full_name|default:msg.sender }}
                    </p>

                    <div class="inline-block relative text-left">
                        <!-- 吹き出し -->
                        <div class="chat-bubble break-words inline-block max-w-xs text-left rounded-lg
                            {% if msg.image_url %}
                                bg-transparent
                            {% else %}
                                {% if msg.sender == request.user.username or msg.sender == request.user.full_name %}
                                    bg-blue-600 text-white p-3
                                {% else %}
                                    bg-gray-600 text-white p-3
                                {% endif %}
                            {% endif %}">

                            {% if msg.image_url %}
                                <!-- ラズパイ側はURLがパスだけで来る場合があるので central_server_url を付与 -->
                                <img src="{% if 'http' not in msg.image_url %}{{ central_server_url }}{% endif %}{{ msg.image_url }}"
                                     class="max-w-full h-auto rounded-lg mb-1 border border-gray-500 bg-white pointer-events-none">
                            {% endif %}

                            {{ msg.content|urlize|linebreaksbr }}
                        </div>
                    </div>
                </div>
            {% empty %}
                {% if selected_group_id != 'all' %}
                    <p class="text-gray-500 text-center mt-4">まだメッセージはありません。</p>
                {% else %}
                    <p class="text-gray-500 text-center mt-4">グループを選択するとメッセージ履歴が表示されます。</p>
                {% endif %}
            {% endfor %}
        </div>

        <!-- メッセージ入力フォーム -->
        <form id="message-form" method="post" class="flex flex-col space-y-4" autocomplete="off" enctype="multipart/form-data">
            {% csrf_token %}
            <!-- 隠しフィールドで現在のグループIDを持たせる -->
            <input type="hidden" name="group_id" value="{{ selected_group_id }}">

            {% if selected_group_id != 'all' or request.user.role in 'admin,rescuer' or request.user.is_superuser %}
                <div class="bg-gray-700 p-4 rounded-lg space-y-3">
                    <!-- 画像選択 -->
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-300 font-bold">添付画像:</label>
                        <input type="file" id="chat-image-input" name="image" accept="image/*"
                               class="text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700">
                    </div>

                    <!-- テキスト入力 -->
                    <div class="flex items-end">
                        <textarea id="message-input" name="message" rows="1"
                               class="flex-1 p-3 border border-gray-500 rounded-l-lg bg-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none overflow-hidden"
                               placeholder="メッセージを入力..."></textarea>
                        <button type="submit" id="submit-btn" class="bg-blue-500 text-white p-3 rounded-r-lg hover:bg-blue-600 font-bold h-full whitespace-nowrap">
                            送信
                        </button>
                    </div>
                </div>
            {% else %}
                <div class="bg-gray-700 p-4 rounded-lg text-center border border-gray-600">
                    <p class="text-yellow-300 font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mb-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        全体連絡は管理者のみ送信可能です
                    </p>
                </div>
            {% endif %}
        </form>
    </div>
{% endblock %}

{% block body_extra %}
    {{ central_server_url|json_script:"central-server-url" }}
    {{ selected_group_id|json_script:"selected-group-id" }}
    {{ request.user.username|json_script:"current-username" }}
    {{ request.user.full_name|json_script:"current-fullname" }}

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const groupSelect = document.getElementById('group-select');
            const chatLog = document.getElementById('chat-log');
            const chatForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const imageInput = document.getElementById('chat-image-input');
            const submitBtn = document.getElementById('submit-btn');

            const centralServerUrlRaw = JSON.parse(document.getElementById('central-server-url').textContent);
            const groupId = JSON.parse(document.getElementById('selected-group-id').textContent);
            const currentUsername = JSON.parse(document.getElementById('current-username').textContent);
            const currentFullname = JSON.parse(document.getElementById('current-fullname').textContent);

            // --- 0. 共通関数 ---
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            function escapeHtml(text) {
                if (!text) return "";
                return text.replace(/[&<>"']/g, function(m) {
                    return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
                });
            }

            function urlify(text) {
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                return text.replace(urlRegex, '<a href="$&" target="_blank" class="underline hover:text-blue-300" onclick="event.stopPropagation()">$&</a>').replace(/\n/g, '<br>');
            }

            // --- 1. UI動作 ---
            // グループ変更
            groupSelect.addEventListener('change', function () {
                window.location.href = `{% url 'field_app:field_chat' %}?group_id=${this.value}`;
            });

            // テキストエリア自動リサイズ
            if(messageInput){
                messageInput.addEventListener('input', function () {
                    this.style.height = 'auto';
                    this.style.height = (this.style.scrollHeight) + 'px';
                });
                // Enter送信
                messageInput.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (submitBtn && !submitBtn.disabled) submitBtn.click();
                    }
                });
            }

            // 初期スクロール
            chatLog.scrollTop = chatLog.scrollHeight;


            // --- 2. メッセージ追加ロジック (appendMessage) ---
            function appendMessage(msgId, senderUsername, message, imageUrl, senderFullName, isTemp = false) {
                const isMe = (senderUsername === currentUsername);
                const displayName = senderFullName || senderUsername;

                const msgDiv = document.createElement('div');
                msgDiv.id = 'msg-' + msgId;
                msgDiv.className = 'message-container text-base relative group mb-4' + (isMe ? ' text-right' : '');

                if (isTemp) {
                    msgDiv.classList.add('message-temp', 'opacity-70');
                } else {
                    msgDiv.dataset.msgId = msgId;
                }

                const senderP = document.createElement('p');
                senderP.className = 'font-bold text-sm text-gray-400 mb-1';
                senderP.textContent = displayName + (isTemp ? ' (送信中...)' : '');
                msgDiv.appendChild(senderP);

                const bubbleContainer = document.createElement('div');
                bubbleContainer.className = 'inline-block relative text-left';

                const bubble = document.createElement('div');
                let bubbleClass = 'chat-bubble break-words inline-block max-w-xs text-left rounded-lg';

                if (imageUrl) {
                    // 画像がある場合は背景透明
                    bubbleClass += ' bg-transparent';
                } else {
                    if (isMe) {
                        // 自分（右側）の場合は青背景
                        bubbleClass += ' bg-blue-600 text-white p-3';
                    } else {
                        // 他人（左側）の場合はグレー背景
                        bubbleClass += ' bg-gray-600 text-white p-3';
                    }
                }
                bubble.className = bubbleClass;

                // 画像処理
                if (imageUrl) {
                    let fullImageUrl = imageUrl;
                    if (!imageUrl.startsWith('http') && !imageUrl.startsWith('blob:')) {
                        // パスだけならベースURLを結合 (末尾スラッシュ除去)
                        const baseUrl = centralServerUrlRaw.replace(/\/$/, '');
                        fullImageUrl = baseUrl + imageUrl;
                    }

                    const img = document.createElement('img');
                    img.src = fullImageUrl;
                    // ★白背景追加
                    img.className = "max-w-full h-auto rounded-lg mb-1 border border-gray-500 bg-white pointer-events-none";
                    bubble.appendChild(img);
                }

                // テキスト処理
                if (message) {
                    const textSpan = document.createElement('span');
                    textSpan.innerHTML = urlify(escapeHtml(message));
                    bubble.appendChild(textSpan);
                }

                bubbleContainer.appendChild(bubble);
                msgDiv.appendChild(bubbleContainer);
                chatLog.appendChild(msgDiv);
                chatLog.scrollTop = chatLog.scrollHeight;
            }


            // --- 3. フォーム送信処理 (即時反映 & POST送信) ---
            if(chatForm){
                chatForm.onsubmit = function (e) {
                    e.preventDefault(); // デフォルトのPOST送信を止める

                    if (submitBtn.disabled) return; // 連打防止

                    const message = messageInput.value;
                    const imageFile = imageInput ? imageInput.files[0] : null;

                    if (message.trim() === '' && !imageFile) return;

                    // ボタン無効化
                    submitBtn.disabled = true;
                    submitBtn.textContent = '送信中...';
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');

                    // A. 即時反映 (仮表示)
                    const tempId = 'temp-' + Date.now();
                    let previewUrl = null;
                    if (imageFile) previewUrl = URL.createObjectURL(imageFile);

                    // ※ラズパイからは自分のフルネームが即座に取れない場合があるので、とりあえずIDか現在名を表示
                    appendMessage(tempId, currentUsername, message, previewUrl, currentFullname, true);

                    // B. サーバーへ送信 (POST)
                    // field_chat_view の実装に合わせて FormData を送る
                    // ※ ここではHTMLフォームの action ではなく、fetch で API (またはView) を叩く必要あり
                    //   現状の views.py は POST 後に redirect する作りなので、fetch で呼ぶとリダイレクト先(HTML)が返ってきてしまう。
                    //   ★対策: field_chat_view を叩いてリロードさせるか、APIを直接叩くか。
                    //   メインサーバーと同じUXにするなら「APIを叩く」のが正解ですが、ラズパイのView構造を変えるのが手間なら
                    //   「フォームを普通にsubmitする（即時反映なし）」に戻すのも手です。

                    //   ここでは「即時反映UX」を実現するため、form.submit() ではなく fetch で API を叩く実装にします。
                    //   config.CENTRAL_SERVER_URL + ...post-group-message/ を叩きます。

                    const formData = new FormData();
                    formData.append('group_id', groupId);
                    formData.append('message', message);
                    if (imageFile) formData.append('image', imageFile);

                    // ラズパイ→中央サーバーへのAPI URLを作成
                    // "http://54.xx.xx.xx:8000/api/post-group-message/"
                    const baseUrl = centralServerUrlRaw.replace(/\/$/, '');
                    const apiUrl = baseUrl + '/api/post-group-message/';

                    fetch(apiUrl, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            // ラズパイからの認証用ヘッダー
                            'X-User-Login-Id': currentUsername
                            // 'Content-Type': multipart/form-data は自動設定
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            messageInput.value = '';
                            if(imageInput) imageInput.value = '';
                            messageInput.style.height = 'auto';
                        } else {
                            console.error('送信エラー', response);
                            alert('送信に失敗しました。オフラインの可能性があります。');
                            // 仮表示を消すなどのロールバック処理が理想
                        }
                    })
                    .catch(error => {
                        console.error('通信エラー:', error);
                        alert('通信エラーが発生しました。');
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.textContent = '送信';
                        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        messageInput.focus();
                    });
                };
            }


            // --- 4. WebSocket接続 (受信専用) ---
            let wsProtocol = 'ws://';
            if (centralServerUrlRaw.startsWith('https')) wsProtocol = 'wss://';
            const host = centralServerUrlRaw.replace(/^https?:\/\//, '');

            if (groupId) {
                const wsUrl = wsProtocol + host + '/ws/chat/group/' + groupId + '/';
                console.log("Connecting WS URL:", wsUrl); // ★接続先URLを確認

                const chatSocket = new WebSocket(wsUrl);

                chatSocket.onopen = function(e) {
                    console.log("★WebSocket Connected!"); // ★接続成功ログ
                };

                chatSocket.onclose = function(e) {
                    console.error("★WebSocket Closed unexpectedly. Code:", e.code, "Reason:", e.reason);
                };

                chatSocket.onerror = function(err) {
                    console.error("★WebSocket Error:", err);
                };

                chatSocket.onmessage = function(e) {
                    const data = JSON.parse(e.data);

                    // ★データ受信ログ
                    console.log("WebSocket受信:", data);
                    console.log("自分(JS):", currentUsername, " 送信者(Server):", data.sender);
                    console.log("判定結果:", data.sender === currentUsername);

                    if (data.type === 'delete') {
                        const el = document.getElementById('msg-' + data.message_id);
                        if(el) el.remove();
                    } else {
                        // 二重表示防止: 自分のIDで返ってきた場合、仮表示を消す
                        if (data.sender === currentUsername) {
                            console.log("自分のメッセージなので仮表示を消します");
                            const tempMsgs = document.querySelectorAll('.message-temp');
                            tempMsgs.forEach(el => el.remove());
                        }

                        appendMessage(data.id, data.sender, data.message, data.image_url, data.sender_full_name);
                    }
                };
            }
        });
    </script>
{% endblock %}