{% extends 'field_app/base.html' %}

{% block title %}現場チャット{% endblock %}
{% block header_title %}現場チャット・レポート{% endblock %}

{% block content %}
    <div class="flex-1 flex flex-col p-4 space-y-4">
        <form id="message-form" method="post" class="flex-1 flex flex-col space-y-4" autocomplete="off" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="bg-gray-700 p-4 rounded-lg">
                <label for="group-select" class="block text-lg font-semibold mb-2 text-white">宛先グループ:</label>
                <select name="group_id" id="group-select" class="p-2 w-full border rounded-md bg-gray-600 text-white">
                    <option value="all" {% if selected_group_id == 'all' %}selected{% endif %}>本部 (全体連絡)</option>
                    {% for group in groups %}
                        <option value="{{ group.id }}"
                                {% if group.id|stringformat:"s" == selected_group_id %}selected{% endif %}>{{ group.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- チャットメッセージリスト -->
            <div id="chat-log"
                 class="flex-1 bg-gray-800 p-4 rounded-lg shadow-inner overflow-y-auto border border-gray-700 space-y-3">
                {% for msg in messages_history %}
                    <div class="text-base {% if msg.sender == request.user.username or msg.sender == request.user.full_name %}text-right{% endif %}">
                        <p class="font-bold text-sm text-gray-400 mb-1">{{ msg.sender }}</p>
                        <p class="break-words p-3 rounded-lg inline-block max-w-xs text-left {% if msg.sender == request.user.username or msg.sender == request.user.full_name %}bg-blue-600 text-white{% else %}bg-gray-600 text-white{% endif %}">
                        {% if msg.image_url %}
                            <img src="{{ central_server_url }}{{ msg.image_url }}" class="max-w-full h-auto rounded-lg mb-2">
                            <br>
                        {% endif %}
                            {{ msg.content|urlize|linebreaksbr }}
                        </p>
                    </div>
                {% empty %}
                    {% if selected_group_id != 'all' %}
                        <p class="text-gray-500">まだメッセージはありません。</p>
                    {% else %}
                        <p class="text-gray-500">グループを選択するとメッセージ履歴が表示されます。</p>
                    {% endif %}
                {% endfor %}
            </div>

            <!-- メッセージ入力 -->
            {# 「全体連絡以外」 または 「管理者・救助チーム」 の場合のみフォームを表示 #}
            {% if selected_group_id != 'all' or request.user.role in 'admin,rescuer' or request.user.is_superuser %}
            <div class="bg-gray-700 p-4 rounded-lg">
                <div class="flex flex-col gap-2">
                    <input type="file" name="image" accept="image/*" class="text-white text-sm">
                    <div class="flex">
                        <input type="text" id="message-input" name="message" class="flex-1 p-3 border rounded-l-md bg-gray-600 text-white"
                           placeholder="メッセージを入力...">
                        <button type="submit" class="bg-blue-500 text-white p-3 rounded-r-md">送信</button>
                    </div>
                </div>
            </div>


            {% else %}

                {# ★★★ 権限がない場合の表示 ★★★ #}
                <div class="bg-gray-700 p-4 rounded-lg text-center border border-gray-600">
                    <p class="text-yellow-300 font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mb-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        全体連絡は管理者のみ送信可能です
                    </p>
                </div>

            {% endif %}
        </form>
    </div>
{% endblock %}

{% block body_extra %}
    <!-- DjangoからJavaScriptへ変数を渡すためのjson_script -->
    {{ central_server_url|json_script:"central-server-url" }}
    {{ selected_group_id|json_script:"selected-group-id" }}
    {{ request.user.username|json_script:"current-username" }}
    {{ request.user.full_name|json_script:"current-fullname" }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const groupSelect = document.getElementById('group-select');
            const chatLog = document.getElementById('chat-log');

            // Djangoから渡された変数を取得
            const centralServerUrlRaw = JSON.parse(document.getElementById('central-server-url').textContent);
            const groupId = JSON.parse(document.getElementById('selected-group-id').textContent);
            const currentUsername = JSON.parse(document.getElementById('current-username').textContent);
            const currentFullname = JSON.parse(document.getElementById('current-fullname').textContent);

            // --- 1. グループ選択時のリロード処理 ---
            groupSelect.addEventListener('change', function () {
                const groupId = this.value;
                window.location.href = `{% url 'field_app:field_chat' %}?group_id=${groupId}`;
            });

            // --- 2. 初期スクロール ---
            chatLog.scrollTop = chatLog.scrollHeight;

            // --- 3. WebSocket接続処理 (ここから追記) ---

            // 中央サーバーのURLから "http://" などを取り除いて WebSocket用URL ("ws://") を作る
            // 例: http://example.com:8000 -> ws://example.com:8000
            let wsProtocol = 'ws://';
            if (centralServerUrlRaw.startsWith('https')) {
                wsProtocol = 'wss://';
            }
            const host = centralServerUrlRaw.replace(/^https?:\/\//, '');

            // グループが選択されている場合のみ接続
            if (groupId) {
                const wsUrl = wsProtocol + host + '/ws/chat/group/' + groupId + '/';
                console.log("Connecting to WebSocket:", wsUrl);

                const chatSocket = new WebSocket(wsUrl);

                chatSocket.onopen = function(e) {
                    console.log("WebSocket Connected!");
                };

                chatSocket.onclose = function(e) {
                    console.error("WebSocket connection closed unexpectedly.");
                };

                chatSocket.onmessage = function(e) {
                    const data = JSON.parse(e.data);
                    // メッセージを受信したら画面に追加
                    appendMessage(data);
                };
            }

            // --- 4. メッセージ追加関数 ---
            function appendMessage(data) {
                const message = data.message;
                const sender = data.sender; // 送信者名 (username または full_name)
                const imageUrl = data.image_url; // 画像URL

                // 自分が送信者かどうか判定 (POST後のリロードで見えている場合は重複するが、リアルタイム受信の確認用)
                // ※ 現在のビュー実装だとPOST後にリロードが入るため、自分のメッセージはリロードで表示されます。
                //    WebSocketは「他人のメッセージ」をリアルタイム表示するために機能します。
                const isMe = (sender === currentUsername || sender === currentFullname);

                // HTML要素の作成
                const msgDiv = document.createElement('div');
                msgDiv.className = 'text-base' + (isMe ? ' text-right' : '');

                const senderP = document.createElement('p');
                senderP.className = 'font-bold text-sm text-gray-400 mb-1';
                senderP.textContent = sender;

                const contentP = document.createElement('p');
                // スタイルクラスの適用（Djangoテンプレートと同じ条件分岐）
                let bubbleClass = 'break-words p-3 rounded-lg inline-block max-w-xs text-left ';
                if (isMe) {
                    bubbleClass += 'bg-blue-600 text-white';
                } else {
                    bubbleClass += 'bg-gray-600 text-white';
                }
                contentP.className = bubbleClass;
                contentP.textContent = message; // XSS対策のため textContent を使用

                if (imageUrl) {
                    // 中央サーバーのURLを補完する必要があるかも（パスだけの場合）
                    // data.image_url が "/media/..." なら centralServerUrlRaw と結合
                    let fullImageUrl = imageUrl;
                    if (!imageUrl.startsWith('http')) {
                         // centralServerUrlRaw は "http://..." を含んでいる前提
                         // 末尾のスラッシュ処理に注意
                         const baseUrl = centralServerUrlRaw.replace(/\/$/, '');
                         fullImageUrl = baseUrl + imageUrl;
                    }

                    const img = document.createElement('img');
                    img.src = fullImageUrl;
                    img.className = "max-w-full h-auto rounded-lg mb-2 border border-gray-400";
                    contentP.appendChild(img);
                }

                // テキストがある場合の処理
                if (message) {
                    const textSpan = document.createElement('span');
                    textSpan.innerHTML = urlify(escapeHtml(message));
                    contentP.appendChild(textSpan);
                }


                // 要素の組み立て
                msgDiv.appendChild(senderP);
                msgDiv.appendChild(contentP);

                // チャットログに追加してスクロール
                chatLog.appendChild(msgDiv);
                chatLog.scrollTop = chatLog.scrollHeight;
            }
        });
    </script>
{% endblock %}